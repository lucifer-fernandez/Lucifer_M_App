<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch & Earn App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--tg-theme-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
            text-align: center;
        }
        h1 {
            color: var(--tg-theme-text-color, #333);
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        .balance-box {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #balanceDisplay {
            font-size: 2.5em;
            font-weight: bold;
            color: #4CAF50; /* Green for money */
            margin-bottom: 10px;
        }
        .actions button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s;
            color: white;
            font-weight: bold;
        }
        #watchAdBtn {
            background-color: var(--tg-theme-button-color, #007bff);
        }
        #saveEarningsBtn {
            background-color: #FFA500; /* Orange for saving */
        }
        #withdrawBtn {
            background-color: #DC3545; /* Red for withdrawal */
        }
        .actions button:hover {
            opacity: 0.9;
        }
        .form-container {
            margin-top: 20px;
            text-align: left;
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            padding: 20px;
            border-radius: 10px;
            display: none; /* Initially hidden */
        }
        .form-container input, .form-container select {
            width: 95%;
            padding: 10px;
            margin: 8px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
        }
    </style>
</head>
<body>
    <h1>ðŸ’µ Watch For Earn Mini App</h1>

    <div class="balance-box">
        <p>Your Current Local Earnings (Unsaved):</p>
        <div id="balanceDisplay">$0.0000 USD</div>
        <small>Ad earnings are temporarily stored here until you save or withdraw.</small>
    </div>

    <div class="actions">
        <button id="watchAdBtn" onclick="watchAd()">ðŸš€ Watch Ad & Earn</button>
        
        <button id="saveEarningsBtn" onclick="saveEarningsToBot()">ðŸ’¾ Save Earnings to Bot</button>

        <button id="withdrawBtn" onclick="openWithdrawForm()">ðŸ’¸ Withdraw Earnings</button>
    </div>

    <div class="form-container" id="withdrawForm">
        <h2>Submit Withdrawal Request</h2>
        <input type="text" id="fullName" placeholder="Your Full Name" required>
        <select id="methodSelect" required>
            <option value="">Select Payment Method</option>
            <option value="bKash">bKash</option>
            <option value="Nagad">Nagad</option>
            <option value="PayPal">PayPal</option>
            <option value="Other">Other</option>
        </select>
        <input type="text" id="accountDetails" placeholder="Account Number / Wallet Address" required>
        <input type="number" id="withdrawAmount" placeholder="Amount (min $2.00)" min="2.00" step="0.01" required>
        <button id="submitWithdrawal" onclick="submitWithdrawal()">Submit Request</button>
        <button id="cancelWithdrawal" onclick="closeWithdrawForm()" style="background-color: #6c757d;">Cancel</button>
    </div>

    <script>
        // Initialize Telegram Web App
        const TELEGRAM_WEB_APP = window.Telegram.WebApp;
        TELEGRAM_WEB_APP.ready();
        
        // Configuration
        const EARNINGS_PER_AD = 0.0035;
        const MIN_WITHDRAWAL_AMOUNT = 2.00;

        // --- Utility Functions ---

        function getBalance() {
            // Retrieve balance from local storage, default to 0 if not found
            return parseFloat(localStorage.getItem('balance')) || 0;
        }

        function updateBalanceDisplay(newBalance) {
            // Save to local storage and update display
            localStorage.setItem('balance', newBalance.toFixed(4));
            document.getElementById('balanceDisplay').textContent = `$${newBalance.toFixed(4)} USD`;
        }

        function watchAd() {
            // Simulating an ad watch duration and success
            TELEGRAM_WEB_APP.showProgress(true);
            TELEGRAM_WEB_APP.MainButton.setText('Watching Ad...');
            TELEGRAM_WEB_APP.MainButton.show();
            TELEGRAM_WEB_APP.MainButton.disable();

            setTimeout(() => {
                TELEGRAM_WEB_APP.showProgress(false);
                TELEGRAM_WEB_APP.MainButton.hide();
                TELEGRAM_WEB_APP.MainButton.enable();
                
                let currentBalance = getBalance();
                currentBalance += EARNINGS_PER_AD;
                updateBalanceDisplay(currentBalance);
                
                TELEGRAM_WEB_APP.showAlert(`ðŸŽ‰ You earned $${EARNINGS_PER_AD.toFixed(4)}!`);
                
                // Optional: You can uncomment this to auto-close the Mini App after watching the ad
                // TELEGRAM_WEB_APP.close(); 
            }, 3000); // Simulate 3 seconds ad viewing
        }
        
        // --- NEW: SAVE EARNINGS TO BOT ---
        function saveEarningsToBot() {
            const currentBalance = getBalance();
            
            if (currentBalance < 0.0001) {
                TELEGRAM_WEB_APP.showAlert('Your current local earnings are $0.00. Watch an ad first!');
                return;
            }

            const dataToSend = {
                action: 'SAVE_EARNINGS',
                amount_usd: currentBalance.toFixed(4)
            };

            // Send the data to the bot
            TELEGRAM_WEB_APP.sendData(JSON.stringify(dataToSend));
            
            // Clear local storage balance after sending (assuming success)
            updateBalanceDisplay(0); 
            
            // Optionally close the app to return to bot conversation
            TELEGRAM_WEB_APP.close();
        }

        // --- WITHDRAWAL LOGIC ---

        function openWithdrawForm() {
            if (getBalance() < MIN_WITHDRAWAL_AMOUNT) {
                TELEGRAM_WEB_APP.showAlert(`âš ï¸ Minimum withdrawal amount is $${MIN_WITHDRAWAL_AMOUNT.toFixed(2)} USD. Keep earning!`);
                return;
            }
            // Show form and hide main buttons
            document.querySelector('.actions').style.display = 'none';
            document.getElementById('withdrawForm').style.display = 'block';
            document.getElementById('withdrawAmount').value = getBalance().toFixed(4); // Pre-fill with max balance
        }

        function closeWithdrawForm() {
            document.getElementById('withdrawForm').style.display = 'none';
            document.querySelector('.actions').style.display = 'block';
        }

        function submitWithdrawal() {
            const fullName = document.getElementById('fullName').value.trim();
            const method = document.getElementById('methodSelect').value;
            const accountDetails = document.getElementById('accountDetails').value.trim();
            const amount = parseFloat(document.getElementById('withdrawAmount').value);

            if (!fullName || !method || !accountDetails || isNaN(amount)) {
                TELEGRAM_WEB_APP.showAlert('Please fill in all fields correctly.');
                return;
            }
            if (amount < MIN_WITHDRAWAL_AMOUNT || amount > getBalance()) {
                TELEGRAM_WEB_APP.showAlert(`Invalid amount. Must be between $${MIN_WITHDRAWAL_AMOUNT.toFixed(2)} and $${getBalance().toFixed(2)}.`);
                return;
            }

            const dataToSend = {
                action: 'WITHDRAWAL_REQUEST',
                full_name: fullName,
                amount_usd: amount.toFixed(4),
                method: method,
                account_details: accountDetails
            };

            // Send the data to the bot
            TELEGRAM_WEB_APP.sendData(JSON.stringify(dataToSend));

            // Clear local storage balance
            const remainingBalance = getBalance() - amount;
            updateBalanceDisplay(remainingBalance);
            
            TELEGRAM_WEB_APP.showAlert('âœ… Withdrawal request submitted! Check your bot conversation.');
            TELEGRAM_WEB_APP.close();
        }

        // Load balance on app start
        document.addEventListener('DOMContentLoaded', () => {
            updateBalanceDisplay(getBalance());
        });
    </script>
</body>
</html>
